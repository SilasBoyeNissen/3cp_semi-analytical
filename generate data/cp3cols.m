function T = cp3cols(Sg, Sr) % finds the location and the distance to the new circle
T = NaN(1, 3);
[m, k] = mink(Sr(:, 3), 3);
Sr = Sr(k, :);
So = Sr;
Sr(:, 1:2) = Sr(:, 1:2) - So(1, 1:2);
o = pi/2 - atan(Sr(2, 2)/Sr(2, 1));
Sr(:, 3) = Sr(:, 3) - m(1) + [0; 10*eps; 0];
Sr(2:3, 1:2) = ([cos(o) -sin(o); sin(o) cos(o)]*Sr(2:3, 1:2)')';
r2 = Sr(2, 3); r3 = Sr(3, 3); x3 = Sr(3, 1); y2 = Sr(2, 2); y3 = Sr(3, 2);
x3y3 = x3^2 + y3^2; sq = sqrt(r2^2*x3^2*(r2 - y2)*(r2 + y2)*((r2 - r3)^2 - x3^2 - (y2 - y3)^2)*(-r3^2 + x3^2 + y3^2));
dr = (r2^3*r3*y2*y3 - r2^4*x3y3 + (r2*r3*y2^2*(-r3^2 + x3^2 - y2*y3 + y3^2) + r2^2*y2*(r3^2*y3 + (y2 - y3)*x3y3) + [1 -1]*y2*sq)) / (2*r2*((r3 - x3)*(r3 + x3)*y2^2 - 2*r2*r3*y2*y3 + r2^2*x3y3));
dr(dr < eps) = NaN;
[dr, i] = min(dr);
if ~isnan(dr)
    T = [dr - m(1) - 10*eps ([cos(o) sin(o); -sin(o) cos(o)]*[(r2^4*r3*x3^2 - r2^2*r3*x3^2*y2^2 + r2*x3^2*y2^2*(r3^2 - x3^2 + (y2 - y3)*y3) + (-1)^i*r3*y2*sq - (-1)^i*r2*y3*sq + r2^3*x3^2*(-r3^2 + x3^2 - ...
        y2*y3 + y3^2))/ (2*r2*x3*((r3 - x3)*(r3 + x3)*y2^2 - 2*r2*r3*y2*y3 + r2^2*x3y3)); ((r3 - x3)*(r3 + x3)*y2^3 + r2^3*r3*y3 + (-1)^i*sq + r2^2*(y3^3 - r3^2*(y2 + y3) + x3^2*(y2 + y3)) ...
        + r2*r3*y2*(r3^2 - x3^2 - y3*(y2 + y3)))/(2*((r3 - x3)*(r3 + x3)*y2^2 - 2*r2*r3*y2*y3 + r2^2*x3y3))] + So(1, 1:2)')'];
    s = (So(1, 1) - So(2, 1))*(So(3, 2) - So(1, 2))-(So(3, 1) - So(1, 1))*(So(1, 2) - So(2, 2));
    if ~(s*((So(3, 1)-T(2))*(So(2, 2)-So(3, 2)) - (So(2, 1)-So(3, 1))*(So(3, 2)-T(3)))>=0 && s*((So(1, 1)-T(2))*(So(3, 2)-So(1, 2)) - (So(3, 1)-So(1, 1))*(So(1, 2)-T(3)))>=0 && ...
        s*((So(2, 1)-T(2))*(So(1, 2)-So(2, 2)) - (So(1, 1)-So(2, 1))*(So(2, 2)-T(3)))>=0)
        T = NaN(1, 3);
    else
        T([0 T(2:3)] > 1) = T([0 T(2:3)] > 1) - 1;
        T([0 T(2:3)] < 0) = T([0 T(2:3)] < 0) + 1;
        if any((Sg(:, 3) + T(1)).^2 > (T(2) - Sg(:, 1)).^2 + (T(3) - Sg(:, 2)).^2)
            T = NaN(1, 3);
        end
    end
end